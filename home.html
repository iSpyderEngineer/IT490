<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Scene Sync Home</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <br>
    
    <div id="welcomeMessage"></div>

    <!-- Include the navbar container -->
    <div id="navbar-container"></div>

    <!-- Include the search bar component -->
    <div class="search-bar">
        <input type="text" id="search-input" placeholder="Search for movies Here!" class="search-input">
        <button id="search-button">Search</button>
        <div id="search-results"></div>
    </div>

    <script>
        // Retrieve session information from sessionStorage
        const sessionid = sessionStorage.getItem('sessionid');
        const username = sessionStorage.getItem('username');

        if (!sessionid || !username) {
            // Redirect to the login page if session information is not found
            location.href = "index.html";
        }

        console.log(sessionid);
        console.log(username);

        let sessionData = {
            sessionid: sessionid
        };

        function validateSession() {
            sessionData.type = "validate_session";
            console.log(sessionData);

            $.ajax({
                url: 'sessionValidate.php',
                method: 'POST',
                data: sessionData,
                dataType: 'json',
                success: function (result) {
                    if (result.returnCode != "1") {
                        // Clear session information and redirect to the login page
                        sessionStorage.removeItem('sessionid');
                        sessionStorage.removeItem('username');
                        location.href = "index.html";
                    }
                },
                error: function () {
                    console.log("Error validating session");
                }
            });
        }

        validateSession();

        function goToProfile() {
            location.href = "profile.php?u=" + encodeURIComponent(username);
        }

        function logout() {
            sessionData.type = "logout";

            $.ajax({
                url: 'sessionValidate.php',
                method: 'POST',
                data: sessionData,
                success: function () {
                    // Clear session information and redirect to the login page
                    sessionStorage.removeItem('sessionid');
                    sessionStorage.removeItem('username');
                    location.href = "index.html";
                },
                error: function () {
                    console.log("Error logging out");
                }
            });
        }

        function setWelcomeMessage() {
            let welcomeMessage = document.getElementById("welcomeMessage");
            welcomeMessage.innerHTML = `Welcome, ${username} to Scene Sync! Try and find some movies you'd like based on ur preferences.`;
        }

        // Fetch and inject the navbar component
        fetch('components/navbar.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('navbar-container').innerHTML = data;
                setWelcomeMessage();
            })
            .catch(error => console.error(error));

        // Define a searchMovies function
        function searchMovies() {
            let query = $('#search-input').val();

            // Make an AJAX request to your APIConsumer
            $.ajax({
                url: 'RabbitMQ/apiConsumer.php',
                method: 'POST',
                data: {
                    type: 'searchMoviesAndTVShows',
                    query: query
                },
                dataType: 'json',
                success: function (response) {
                    console.log(response);
                    displayResults(response);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error(errorThrown);
                    // Handle errors here
                }
            });
            
            // Append the "Type" field to the URL
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('Type', 'searchMoviesAndTVShows');
            history.replaceState(null, null, '?' + urlParams.toString());
        }

        function displayResults(results) {
            let searchResultsDiv = $('#search-results');
            searchResultsDiv.empty();

            results.forEach(function (item) {
                let title = item['Title'];
                let movieID = item['ID'];

                // Append the "Type" parameter to the URL
                const urlParams = new URLSearchParams();
                urlParams.set('movieID', movieID);
                urlParams.set('Type', 'searchMoviesAndTVShows');
                let titleLink = $('<a>').text(title).attr('href', 'movie.html?' + urlParams.toString());
                
                // Add click event listener to the titleLink
                titleLink.click(function () {
                    // Redirect to movie.html with the movieID parameter
                    location.href = 'movie.html?' + urlParams.toString();
                });

                searchResultsDiv.append(titleLink).append('<br>');
            });
        }

        // Add an event listener for the search button click
        $(document).ready(function () {
            $('#search-button').click(function () {
                searchMovies();
            });
        });
    </script>
</body>
</html>
