<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>New Profile</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="error"></div>

    <div>
        <form id="newProfileForm">
            <h4>New Profile</h4>
            <table>
                <tr>
                    <th>Favorite Actor:</th>
                    <td><input type="text" id="favoriteActorInput" size="25" required></td>
                </tr>
                <tr>
                    <th>Favorite Movie:</th>
                    <td>
                        <input type="text" id="favoriteMovieInput" size="25" required>
                        
                    </td>
                </tr>
                <tr>
                    <th>Favorite Director:</th>
                    <td><input type="text" id="favoriteDirectorInput" size="25" required></td>
                </tr>
                <tr>
                    <th>Favorite Genre:</th>
                    <td>
                        <select id="favoriteGenre" name="favoriteGenre" required>
                            <option value="Action">Action</option>
                            <option value="Comedy">Comedy</option>
                            <!-- Add more options for other genres -->
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Biography:</th>
                    <td><textarea id="biography" name="biography" rows="4" cols="50" required></textarea></td>
                </tr>
            </table>
            <button type="button" name="submitProfile" id="submitProfile">Submit Profile</button>
        </form>
    </div>

    <script>
        
        let error = $("#error");

        // Search and populate movie dropdown options on input change for favoriteMovie
        $("#favoriteMovieInput").on("input", function() {
            // Removed the code that populated options on every input change
            // Now, it won't trigger a search for every letter typed
        });

        $("#submitProfile").on("click", async function () {
            const username = sessionStorage.getItem('username'); // Retrieve username from sessionStorage

            const favoriteActor = $("#favoriteActorInput").val();
            const favoriteDirector = $("#favoriteDirectorInput").val();
            const favoriteMovie = $("#favoriteMovieInput").val();
            const favoriteGenre = $("#favoriteGenre").val();
            const biography = sanitizeBiography($("#biography").val());

            const isActorValid = await validatePersonExists(favoriteActor);
            const isDirectorValid = await validatePersonExists(favoriteDirector);
            const isMovieValid = await validateMovieExists(favoriteMovie);

            if (!isActorValid) {
                showMessage("Favorite actor does not exist!", "error");
                return;
            }

            if (!isDirectorValid) {
                showMessage("Favorite director does not exist!", "error");
                return;
            }

            if (!isMovieValid) {
                showMessage("Favorite movie does not exist!", "error");
                return;
            }

            if (!favoriteActor || !favoriteMovie || !favoriteDirector || !favoriteGenre || !biography) {
                showMessage("All fields are required!", "error");
                return;
            }

            try {
                await submitProfileToRabbitMQ(username, favoriteActor, favoriteDirector, favoriteGenre, favoriteMovie, biography);
                showMessage("Profile submitted successfully!", "success");
                sessionStorage.removeItem('username');
                window.location.href = "index.html";
            } catch (error) {
                console.error(error);
                showMessage("Failed to submit profile!", "error");
            }
        });


        async function validatePersonExists(personName) {
            try {
                let response = await $.ajax({
                    url: 'RabbitMQ/apiConsumer.php',
                    method: 'POST',
                    data: {"type": "searchPerson" , "personName": personName  },
                    dataType: 'json'
                });
                return response && response.success;
            } catch (error) {
                console.error(error);
                return false;
            }
        }

        async function validateMovieExists(movieName) {
            try {
                let response = await $.ajax({
                    url: 'RabbitMQ/apiConsumer.php',
                    method: 'POST',
                    data: {"type": "searchMoviesAndTVShows", "query": movieName ,},
                    dataType: 'json'
                });
                return response && response.success;
            } catch (error) {
                console.error(error);
                return false;
            }
        }

        function submitProfileToRabbitMQ(username, favoriteActor, favoriteDirector, favoriteGenre, favoriteMovie, biography) {
            return new Promise(async (resolve, reject) => {
                try {
                    let response = await $.ajax({
                        url: 'RabbitMQ/dbConsumer.php',
                        method: "POST",
                        data: {
                            "type": "validatePreferences",
                            "username": username,
                            "favActor": favoriteActor,
                            "favDirector": favoriteDirector,
                            "favGenre": favoriteGenre,
                            "favMovie": favoriteMovie,
                            "biography": biography
                        },
                        dataType: 'json'
                    });
                    if (response && response.success) {
                        console.log("Profile submitted to dbConsumer via RabbitMQ");
                        resolve();
                    } else {
                        reject(new Error("Failed to submit profile to dbConsumer via RabbitMQ"));
                    }
                } catch (error) {
                    console.error(error);
                    reject(error);
                }
            });
        }

        function sanitizeBiography(bio) {
            return bio.replace(/[^a-zA-Z\s'.]/g, '');
        }

        function showMessage(message, result) {
            error.html("<div class='alert alert-" + result + "'>" + message + "</div>");
        }
    </script>
</body>
</html>