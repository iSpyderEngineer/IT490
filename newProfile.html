<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>New Profile</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="error"></div>

    <div>
        <form id="newProfileForm">
            <h4>New Profile</h4>
            <table>
                <tr>
                    <th>Favorite Actor:</th>
                    <td>
                        <input type="text" id="favoriteActorInput" size="25" required>
                        <select id="favoriteActor" name="favoriteActor" required>
                            <!-- Options will be populated dynamically using JavaScript -->
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Favorite Movie:</th>
                    <td>
                        <input type="text" id="favoriteMovieInput" size="25" required>
                        <select id="favoriteMovie" name="favoriteMovie" required>
                            <!-- Options will be populated dynamically using JavaScript -->
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Favorite Director:</th>
                    <td>
                        <input type="text" id="favoriteDirectorInput" size="25" required>
                        <select id="favoriteDirector" name="favoriteDirector" required>
                            <!-- Options will be populated dynamically using JavaScript -->
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Favorite Genre:</th>
                    <td>
                        <select id="favoriteGenre" name="favoriteGenre" required>
                            <option value="Action">Action</option>
                            <option value="Comedy">Comedy</option>
                            <!-- Add more options for other genres -->
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Biography:</th>
                    <td><textarea id="biography" name="biography" rows="4" cols="50" required></textarea></td>
                </tr>
            </table>
            <button type="button" name="submitProfile" id="submitProfile">Submit Profile</button>
        </form>
    </div>
    
    <script>
        let error = $("#error");

        // Populate dropdown options dynamically based on the search term
        async function populateDropdownOptions(endpoint, searchTerm, dropdownId) {
            try {
                let response = await $.ajax({
                    url: `RabbitMQ/${endpoint}`,
                    method: "POST",
                    data: { searchTerm },
                    dataType: 'json'
                });

                if (response && response.success && response.data) {
                    let dropdown = $(`#${dropdownId}`);
                    dropdown.empty(); // Clear existing options
                    response.data.forEach(option => {
                        dropdown.append(`<option value="${option}">${option}</option>`);
                    });
                }
            } catch (error) {
                console.error(error);
            }
        }

        // Search and populate dropdown options when the input changes
        $("#favoriteActorInput").on("input", function() {
            let searchTerm = $(this).val();
            populateDropdownOptions('apiConsumer.php?type=searchPeople', searchTerm, 'favoriteActor');
        });

        $("#favoriteMovieInput").on("input", function() {
            let searchTerm = $(this).val();
            populateDropdownOptions('apiConsumer.php?type=searchMovies', searchTerm, 'favoriteMovie');
        });

        $("#favoriteDirectorInput").on("input", function() {
            let searchTerm = $(this).val();
            populateDropdownOptions('apiConsumer.php?type=searchPeople', searchTerm, 'favoriteDirector');
        });

        $("#submitProfile").on("click", async function () {
            let favoriteActor = $("#favoriteActor").val();
            let favoriteMovie = $("#favoriteMovie").val();
            let favoriteDirector = $("#favoriteDirector").val();
            let favoriteGenre = $("#favoriteGenre").val();
            let biography = sanitizeBiography($("#biography").val());

            // Check if fields are empty
            if (!favoriteActor || !favoriteMovie || !favoriteDirector || !favoriteGenre || !biography) {
                showMessage("All fields are required!", "error");
                return;
            }

            // You can perform additional checks or validations here if needed

            // All exist, proceed with submission
            await submitProfileToRabbitMQ(favoriteActor, favoriteDirector, favoriteGenre, favoriteMovie, biography);
            showMessage("Profile submitted successfully!", "success");
            sessionStorage.removeItem('profileUser');
            window.location.href = "login.html";
        });

        function submitProfileToRabbitMQ(favoriteActor, favoriteDirector, favoriteGenre, favoriteMovie, biography) {
            return new Promise(async (resolve, reject) => {
                try {
                    let response = await $.ajax({
                        url: 'RabbitMQ/dbConsumer.php',
                        method: "POST",
                        data: {
                            type: "updatePreferences",
                            favActor: favoriteActor,
                            favDirector: favoriteDirector,
                            favGenre: favoriteGenre,
                            favMovie: favoriteMovie,
                            biography: biography
                        },
                        dataType: 'json'
                    });

                    if (response && response.success) {
                        console.log("Profile submitted to dbConsumer via RabbitMQ");
                        resolve();
                    } else {
                        reject(new Error("Failed to submit profile to dbConsumer via RabbitMQ"));
                    }
                } catch (error) {
                    console.error(error);
                    reject(error);
                }
            });
        }

        function sanitizeBiography(bio) {
            return bio.replace(/[^a-zA-Z\s'.]/g, '');
        }

        function showMessage(message, result) {
            error.html("<div class='alert alert-" + result + "'>" + message + "</div>");
        }
    </script>
</body>
</html>
