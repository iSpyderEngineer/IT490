<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>About username</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.4/purify.min.js"></script>
    <link rel="stylesheet" href="styles.css"> <!-- Include your CSS file -->
</head>
<body>
    <div id="navbar-container"></div>
    
    <h1>About username</h1>

    <div id="username">
        <h2>Username</h2>
        <p id="username-info"></p>
    </div>

    <div id="actor">
        <h2>Favorite Actor</h2>
        <p id="actor-info"></p>
    </div>

    <div id="movie">
        <h2>Favorite Movie</h2>
        <p id="movie-info"></p>
    </div>

    <div id="director">
        <h2>Favorite Director</h2>
        <p id="director-info"></p>
    </div>

    <div id="genre">
        <h2>Favorite Genre</h2>
        <p id="genre-info"></p>
    </div>

    <div id="rate">
        <h2>Rate Score</h2>
        <p id="rate-info"></p>
    </div>

    <div id="bio">
        <h2>Bio</h2>
        <p id="bio-info"></p>
    </div>

    <button id="edit-profile" style="display: none;">Edit Profile</button>
    
    <div id="edit-form" style="display: none;">
        <form id="profile-form">
            <label for="favoriteActorInput">Favorite Actor:</label>
            <input type="text" id="favoriteActorInput" name="favActor" required>

            <label for="favoriteMovieInput">Favorite Movie:</label>
            <input type="text" id="favoriteMovieInput" name="favMovie" required>

            <label for="favoriteDirectorInput">Favorite Director:</label>
            <input type="text" id="favoriteDirectorInput" name="favDirector" required>

            <label for="favoriteGenre">Favorite Genre:</label>
            <select id="favoriteGenre" name="favGenre" required>
                <option value="Action">Action</option>
                <option value="Comedy">Comedy</option>
                <!-- Add more options for other genres -->
            </select>

            <label for="bio-input">Biography:</label>
            <textarea id="bio-input" name="biography" rows="4" cols="50" required></textarea>

            <button type="button" id="submit-changes">Submit Changes</button>
        </form>
    </div>

    <script>
        // Load the navbar component
        const navbarContainer = document.getElementById('navbar-container');
    
        const xhr = new XMLHttpRequest();
        xhr.open('GET', 'components/navbar.html', true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                navbarContainer.innerHTML = xhr.responseText;
    
                // Call other functions after the navbar is loaded (if needed)
                loadProfileData();
    
                // Event listener for the "Profile" link in the navbar
                $('#profile-link').click(function (event) {
                    event.preventDefault(); // Prevent the default link behavior
                    loadProfileData();
                });

                // Event listener for the "Edit Profile" button
                $('#edit-profile').click(function () {
                    showEditForm();
                });

                // Event listener for the "Submit Changes" button
                $('#submit-changes').click(function () {
                    submitChanges();
                });
            }
        };
        xhr.send();
    
        function loadProfileData() {
            const username = sessionStorage.getItem('username');
            $.ajax({
                url: 'RabbitMQ/dbConsumer.php',
                method: 'GET',
                data: { type: 'getUserProfile', username: username },
                dataType: 'json',
                success: function (result) {
                    if (result[0].FavoriteActor) {
                        $('#actor-info').text(result[0].FavoriteActor);
                    }
                    if (result[0].FavoriteDirector) {
                        $('#director-info').text(result[0].FavoriteDirector);
                    }
                    if (result[0].FavoriteGenres) {
                        $('#genre-info').text(result[0].FavoriteGenres);
                    }
                    if (result[0].FavoriteMovie) {
                        $('#movie-info').text(result[0].FavoriteMovie);
                    }
                    if (result[0].Biography) {
                        $('#bio-info').text(result[0].Biography);
                    }
                    if (result[0].RateScore) {
                        $('#rate-info').text(result[0].RateScore);
                    }
                    // Displaying the username
                    $('#username-info').text(username);
                },
                error: function () {
                    console.log("Error loading profile data");
                }
            });
        }

        function showEditForm() {
            // Load the existing data to the form
            $('#favoriteActorInput').val($('#actor-info').text());
            $('#favoriteMovieInput').val($('#movie-info').text());
            $('#favoriteDirectorInput').val($('#director-info').text());
            $('#favoriteGenre').val($('#genre-info').text());
            $('#bio-input').val($('#bio-info').text());

            // Show the edit form and hide the "Edit Profile" button
            $('#edit-profile').hide();
            $('#edit-form').show();
        }

        function submitChanges() {
            // Validate the form data (you can add more validation)
            const actor = $('#favoriteActorInput').val();
            const movie = $('#favoriteMovieInput').val();
            const director = $('#favoriteDirectorInput').val();
            const genre = $('#favoriteGenre').val();
            const bio = $('#bio-input').val();

            if (!actor || !movie || !director || !genre || !bio) {
                alert("Please fill out all fields before submitting changes.");
                return;
            }

            // Perform the post request to update the profile
            $.ajax({
                url: 'RabbitMQ/updateProfileData.php',
                method: 'POST',
                data: {
                    username: sessionStorage.getItem('username'),
                    field: 'updateProfile',
                    favActor: actor,
                    favMovie: movie,
                    favDirector: director,
                    favGenre: genre,
                    biography: bio
                },
                dataType: 'json',
                success: function (result) {
                    // Handle success response if needed
                    console.log(result);
                    // Reload the page to display the updated information
                    location.reload();
                },
                error: function () {
                    console.log("Error updating profile data");
                }
            });
        }
    </script>
    
</body>
</html>
