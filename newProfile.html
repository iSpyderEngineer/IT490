<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>New Profile</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="error"></div>

    <div>
        <form id="newProfileForm">
            <h4>New Profile</h4>
            <table>
                <tr>
                    <th>Favorite Actor:</th>
                    <td><input type="text" id="favoriteActor" name="favoriteActor" size="25" required></td>
                </tr>
                <tr>
                    <th>Favorite Movie:</th>
                    <td><input type="text" id="favoriteMovie" name="favoriteMovie" size="25" required></td>
                </tr>
                <tr>
                    <th>Favorite Director:</th>
                    <td><input type="text" id="favoriteDirector" name="favoriteDirector" size="25" required></td>
                </tr>
                <tr>
                    <th>Favorite Genre:</th>
                    <td>
                        <input type="radio" id="action" name="favoriteGenre" value="Action">
                        <label for="action">Action</label><br>
                        <input type="radio" id="comedy" name="favoriteGenre" value="Comedy">
                        <label for="comedy">Comedy</label><br>
                        <!-- Add more radio buttons for other genres -->
                    </td>
                </tr>
                <tr>
                    <th>Biography:</th>
                    <td><textarea id="biography" name="biography" rows="4" cols="50" required></textarea></td>
                </tr>
            </table>
            <button type="submit" name="submitProfile" id="submitProfile">Submit Profile</button>
        </form>
    </div>
    
    <script>
        let form = $("#newProfileForm");
        let error = $("#error");

        form.on("submit", async function (event) {
            event.preventDefault();

            let favoriteActor = sanitizeInput($("#favoriteActor").val());
            let favoriteMovie = sanitizeInput($("#favoriteMovie").val());
            let favoriteDirector = sanitizeInput($("#favoriteDirector").val());
            let favoriteGenre = $("input[name='favoriteGenre']:checked").val();
            let biography = sanitizeBiography($("#biography").val());

            // Check if fields are empty
            if (!favoriteActor || !favoriteMovie || !favoriteDirector || !favoriteGenre || !biography) {
                showMessage("All fields are required!", "error");
                return;
            }

            try {
                let actorExists = await checkActorExists(favoriteActor);
                let directorExists = await checkDirectorExists(favoriteDirector);
                let genreExists = true; // You mentioned you don't want to check genre existence
                let movieExists = await checkMovieExists(favoriteMovie);

                if (actorExists && directorExists && genreExists && movieExists) {
                    // All exist, proceed with submission
                    await submitProfileToRabbitMQ(favoriteActor, favoriteDirector, favoriteGenre, favoriteMovie, biography);
                    showMessage("Profile submitted successfully!", "success");
                    sessionStorage.removeItem('profileUser');
                    window.location.href = "login.html";
                } else {
                    if (!actorExists) {
                        showMessage("Favorite Actor does not exist!", "error");
                    }
                    if (!directorExists) {
                        showMessage("Favorite Director does not exist!", "error");
                    }
                    if (!genreExists) {
                        showMessage("Favorite Genre does not exist!", "error");
                    }
                    if (!movieExists) {
                        showMessage("Favorite Movie does not exist!", "error");
                    }
                }
            } catch (error) {
                showMessage(error.message, "error");
            }
        });

        async function checkActorExists(actor) {
            try {
                let response = await $.ajax({
                    url: 'RabbitMQ/apiConsumer.php',
                    method: "POST",
                    data: {
                        type: "searchPerson",
                        personName: actor
                    },
                    dataType: 'json'
                });

                return response && response.success; // Adjust based on your response format
            } catch (error) {
                console.error(error);
                return false;
            }
        }

        async function checkDirectorExists(director) {
            try {
                let response = await $.ajax({
                    url: 'RabbitMQ/apiConsumer.php',
                    method: "POST",
                    data: {
                        type: "searchPerson",
                        personName: director
                    },
                    dataType: 'json'
                });

                return response && response.success; // Adjust based on your response format
            } catch (error) {
                console.error(error);
                return false;
            }
        }

        async function checkMovieExists(movie) {
            try {
                let response = await $.ajax({
                    url: 'RabbitMQ/apiConsumer.php',
                    method: "POST",
                    data: {
                        type: "searchMovies",
                        query: movie
                    },
                    dataType: 'json'
                });

                return response && response.success; // Adjust based on your response format
            } catch (error) {
                console.error(error);
                return false;
            }
        }

        function submitProfileToRabbitMQ(favoriteActor, favoriteDirector, favoriteGenre, favoriteMovie, biography) {
            return new Promise(async (resolve, reject) => {
                try {
                    let response = await $.ajax({
                        url: 'RabbitMQ/dbConsumer.php',
                        method: "POST",
                        data: {
                            type: "updatePreferences",
                            favActor: favoriteActor,
                            favDirector: favoriteDirector,
                            favGenre: favoriteGenre,
                            favMovie: favoriteMovie,
                            biography: biography
                        },
                        dataType: 'json'
                    });

                    if (response && response.success) {
                        console.log("Profile submitted to dbConsumer via RabbitMQ");
                        resolve();
                    } else {
                        reject(new Error("Failed to submit profile to dbConsumer via RabbitMQ"));
                    }
                } catch (error) {
                    console.error(error);
                    reject(error);
                }
            });
        }

        function sanitizeInput(input) {
            return input.replace(/[^a-zA-Z\s]/g, '');
        }

        function sanitizeBiography(bio) {
            return bio.replace(/[^a-zA-Z\s'.]/g, '');
        }

        function showMessage(message, result) {
            error.html("<div class='alert alert-" + result + "'>" + message + "</div>");
        }
    </script>
</body>
</html>
