<!-- Edit Profile Page -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>About username</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.4/purify.min.js"></script>
    <link rel="stylesheet" href="styles.css"> <!-- Include your CSS file -->
</head>
<body>
    <div id="navbar-container"></div>
    
    <h1>About username</h1>

    <div id="username">
        <h2>Username</h2>
        <p id="username-info"></p>
    </div>

    <div id="actor">
        <h2>Favorite Actor</h2>
        <p id="actor-info"></p>
    </div>

    <div id="movie">
        <h2>Favorite Movie</h2>
        <p id="movie-info"></p>
    </div>

    <div id="director">
        <h2>Favorite Director</h2>
        <p id="director-info"></p>
    </div>

    <div id="genre">
        <h2>Favorite Genre</h2>
        <p id="genre-info"></p>
    </div>

    <div id="rate">
        <h2>Rate Score</h2>
        <p id="rate-info"></p>
    </div>

    <div id="bio">
        <h2>Bio</h2>
        <p id="bio-info"></p>
    </div>

    <!-- Edit Profile Form -->
    <div id="edit-profile-form" style="display: none;">
        <h2>Edit Profile</h2>
        <form id="profile-form">
            <label for="edit-actor-input">Favorite Actor:</label>
            <input type="text" id="edit-actor-input" name="edit-actor-input" required>
            <br>

            <label for="edit-movie-input">Favorite Movie:</label>
            <input type="text" id="edit-movie-input" name="edit-movie-input" required>
            <br>

            <label for="edit-director-input">Favorite Director:</label>
            <input type="text" id="edit-director-input" name="edit-director-input" required>
            <br>

            <label for="edit-genre-input">Favorite Genre:</label>
            <input type="text" id="edit-genre-input" name="edit-genre-input" required>
            <br>

            <label for="edit-bio-input">Biography:</label>
            <textarea id="edit-bio-input" name="edit-bio-input" rows="4" cols="50" required></textarea>
            <br>

            <button type="button" id="submit-edit">Submit</button>
        </form>
    </div>

    <button id="edit-profile-button">Edit Profile</button>

    <script>
        $(document).ready(function () {
            // Load the navbar component
            $('#navbar-container').load('components/navbar.html', function () {
                // Call other functions after the navbar is loaded (if needed)
                // Removed loadProfileData() from here

                // Event listener for the "Profile" link in the navbar
                $('#profile-link').click(function (event) {
                    event.preventDefault(); // Prevent the default link behavior
                    loadProfileData();
                });

                // Check if it's the user's own profile page to enable edit functionality, set up for potential future proofing but doesn't really check as of writing
                const isOwnProfile = isCurrentUserProfile(); // Function to check if it's the user's own profile
                if (isOwnProfile) {
                    enableEditFunctionality();
                }

                // Explicitly call loadProfileData() after the document is ready
                loadProfileData();
            });
        });

        function isCurrentUserProfile() {
            const currentSessionUsername = sessionStorage.getItem('username');
            const profileUsername = "";  // This exists for in the future if we let users see each other's profile pages's
            return true;
        }

        function loadProfileData() {
            const username = sessionStorage.getItem('username');
            $.ajax({
                url: 'RabbitMQ/dbConsumer.php',
                method: 'GET',
                data: { type: 'getUserProfile', username: username },
                dataType: 'json',
                success: function (result) {
                    if (result[0].FavoriteActor) {
                        $('#actor-info').text(result[0].FavoriteActor);
                        $('#edit-actor-input').val(result[0].FavoriteActor);
                    }
                    if (result[0].FavoriteMovie) {
                        $('#movie-info').text(result[0].FavoriteMovie);
                        $('#edit-movie-input').val(result[0].FavoriteMovie);
                    }
                    if (result[0].FavoriteDirector) {
                        $('#director-info').text(result[0].FavoriteDirector);
                        $('#edit-director-input').val(result[0].FavoriteDirector);
                    }
                    if (result[0].FavoriteGenres) {
                        $('#genre-info').text(result[0].FavoriteGenres);
                        $('#edit-genre-input').val(result[0].FavoriteGenres);
                    }
                    if (result[0].RateScore) {
                        $('#rate-info').text(result[0].RateScore);
                    }
                    if (result[0].Biography) {
                        $('#bio-info').text(result[0].Biography);
                        $('#edit-bio-input').val(result[0].Biography);
                    }
                    // Displaying the username
                    $('#username-info').text(username);
                },
                error: function () {
                    console.log("Error loading profile data");
                }
            });
        }

        function enableEditFunctionality() {
            // Edit Profile button event listener
            $(document).on('click', '#edit-profile-button', function () {
                // Show the edit profile form
                $('#edit-profile-form').show();
            });

            // Submit Edit button event listener
            $(document).on('click', '#submit-edit', function () {
                // Validate and submit the edited profile data
                const editedActor = $('#edit-actor-input').val();
                const editedMovie = $('#edit-movie-input').val();
                const editedDirector = $('#edit-director-input').val();
                const editedGenre = $('#edit-genre-input').val();
                const editedBio = $('#edit-bio-input').val();

                // You can add further validation if needed

                // Prepare the payload with all edited data
                const payload = {
                    type: 'updateProfile',
                    username: sessionStorage.getItem('username'),
                    favActor: editedActor,
                    favMovie: editedMovie,
                    favDirector: editedDirector,
                    favGenre: editedGenre,
                    biography: editedBio
                };

                // Submit the edited data in one payload
                submitEditedData(payload);

                // Hide the edit profile form after submission
                $('#edit-profile-form').hide();
            });
        }

        function submitEditedData(payload) {
            // Perform AJAX request to submit edited data
            $.ajax({
                url: 'RabbitMQ/dbConsumer.php',
                method: 'POST',
                data: payload,
                dataType: 'json',
                success: function (result) {
                    // Handle success response if needed
                },
                error: function () {
                    console.log("Error updating profile data");
                }
            });
        }
    </script>
    
</body>
</html>
