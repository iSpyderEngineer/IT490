<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Password Reset</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
</head>
<body>
    <h1>Password Reset</h1>

    <!-- "link to send back to the login page" link -->
    <a href="index.html">Back to Login</a>

    <form id="password-reset-form">
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" required><br><br>

        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required><br><br>

        <label for="new-password">New Password:</label>
        <input type="password" id="new-password" name="password" required><br><br>

        <button type="submit">Reset Password</button>
    </form>

    <script>
        $(document).ready(function () {
            $('#password-reset-form').submit(function (event) {
                event.preventDefault(); // Prevents default form submission

                // Sanitize and validate input data
                const username = sanitizeInput($('#username').val());
                const email = sanitizeInput($('#email').val());
                const password = sanitizeInput($('#new-password').val());

                if (username && email && password) {
                    // Hash the password
                    let hashedPassword = CryptoJS.SHA256(password).toString(CryptoJS.enc.Hex);

                    // AJAX request to reset password
                    $.ajax({
                        url: 'RabbitMQ/dbConsumer.php',
                        method: 'POST',
                        data: {
                            type: 'resetPassword',
                            username: username,
                            email: email,
                            password: hashedPassword // Send hashed password
                        },
                        dataType: 'json',
                        success: function (response) {
                            // Handle ful response
                            console.log('Password reset successful:', response);
                            // redirect
                            window.location.href = 'index.html';
                        },
                        error: function (error) {
                            // Handle error response
                            console.error('Error resetting password:', error);
                            
                        }
                    });
                } else {
                    // Handle invalid input
                    console.error('Invalid input.');
                    // Add your logic for invalid input message
                }
            });

            // Function that sanitizes input by removing certain characters
            function sanitizeInput(input) {
                // regex to excludes '.' and '@' from removal but gets rid of other harmful characters
                const sanitizedInput = input.replace(/[\[\]{}()*+?,\\^$|#\s]/g, '');
                return sanitizedInput;
            }

        });
    </script>
</body>
</html>





