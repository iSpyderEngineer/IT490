<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>About username</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.4/purify.min.js"></script>
    <link rel="stylesheet" href="styles.css"> <!-- Include your CSS file -->
</head>
<body>
    <div id="navbar-container"></div>
    
    <h1>About username</h1>

    <div id="username">
        <h2>Username</h2>
        <p id="username-info"></p>
    </div>

    <div id="actor">
        <h2>Favorite Actor</h2>
        <p id="actor-info"></p>
        <button id="edit-actor" style="display: none;">Edit</button>
    </div>

    <div id="movie">
        <h2>Favorite Movie</h2>
        <p id="movie-info"></p>
        <button id="edit-movie" style="display: none;">Edit</button>
    </div>

    <div id="director">
        <h2>Favorite Director</h2>
        <p id="director-info"></p>
        <button id="edit-director" style="display: none;">Edit</button>
    </div>

    <div id="genre">
        <h2>Favorite Genre</h2>
        <p id="genre-info"></p>
        <button id="edit-genre" style="display: none;">Edit</button>
    </div>

    <div id="rate">
        <h2>Rate Score</h2>
        <p id="rate-info"></p>
    </div>

    <div id="bio">
        <h2>Bio</h2>
        <p id="bio-info"></p>
        <button id="edit-bio" style="display: none;">Edit</button>
    </div>

    <script>
        // Load the navbar component
        const navbarContainer = document.getElementById('navbar-container');
    
        const xhr = new XMLHttpRequest();
        xhr.open('GET', 'components/navbar.html', true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                navbarContainer.innerHTML = xhr.responseText;
    
                // Call other functions after the navbar is loaded (if needed)
                loadProfileData();
    
                // Event listener for the "Profile" link in the navbar
                $('#profile-link').click(function (event) {
                    event.preventDefault(); // Prevent the default link behavior
                    loadProfileData("<?php echo $_SESSION['username']; ?>");
                });
    
                // Check if it's the user's own profile page to enable edit functionality
                const isOwnProfile = isCurrentUserProfile(); // Function to check if it's the user's own profile
                if (isOwnProfile) {
                    enableEditFunctionality();
                }
            }
        };
        xhr.send();
    
        function isCurrentUserProfile() {
            const currentSessionUsername = "<?php echo $_SESSION['username']; ?>";
            const profileUsername = "<?php echo isset($_GET['username']) ? $_GET['username'] : $_SESSION['username']; ?>";
            return currentSessionUsername === profileUsername;
        }
    
        function loadProfileData(username) {
            $.ajax({
                url: 'RabbitMQ/dbConsumer.php',
                method: 'POST',
                data: { action: 'getUserProfile', username: username },
                dataType: 'json',
                success: function (result) {
                    if (result.username) {
                        $('#username-info').text(result.username);
                    }
                    if (result.actor) {
                        $('#actor-info').text(result.actor);
                        $('#edit-actor').show();
                    }
                    if (result.movie) {
                        $('#movie-info').text(result.movie);
                        $('#edit-movie').show();
                    }
                    if (result.director) {
                        $('#director-info').text(result.director);
                        $('#edit-director').show();
                    }
                    if (result.genre) {
                        $('#genre-info').text(result.genre);
                        $('#edit-genre').show();
                    }
                    if (result.rate) {
                        $('#rate-info').text(result.rate);
                    }
                    if (result.bio) {
                        $('#bio-info').text(result.bio);
                        $('#edit-bio').show();
                    }
                },
                error: function () {
                    console.log("Error loading profile data");
                }
            });
        }

        function enableEditFunctionality() {
            $('#edit-actor').show();
            $('#edit-movie').show();
            $('#edit-director').show();
            $('#edit-genre').show();
            $('#edit-bio').show();

            function personExists(personName) {
                let result = false;
                $.ajax({
                    url: 'RabbitMQ/apiConsumer.php',
                    method: 'POST',
                    data: { personName: personName },
                    async: false,
                    success: function (response) {
                        result = response.exists;
                    },
                    error: function () {
                        console.log("Error checking person existence");
                    }
                });
                return result;
            }

            function movieExists(movieQuery) {
                let result = false;
                $.ajax({
                    url: 'RabbitMQ/dbConsumer.php',
                    method: 'POST',
                    data: { movieQuery: movieQuery },
                    async: false,
                    success: function (response) {
                        result = response.exists;
                    },
                    error: function () {
                        console.log("Error checking movie existence");
                    }
                });
                return result;
            }

            $('#edit-actor').click(function () {
                const newActor = prompt("Enter your new favorite actor:");
                if (newActor && newActor.trim() !== "") {
                    const sanitizedActor = DOMPurify.sanitize(newActor);
                    if (personExists(sanitizedActor)) {
                        $('#actor-info').text(sanitizedActor);
                        submitProfileData('favActor', sanitizedActor);
                    } else {
                        alert("Invalid actor input. Please enter a valid actor.");
                    }
                } else {
                    alert("Please enter a valid favorite actor.");
                }
            });

            $('#edit-movie').click(function () {
                const newMovie = prompt("Enter your new favorite movie:");
                if (newMovie && newMovie.trim() !== "") {
                    const sanitizedMovie = DOMPurify.sanitize(newMovie);
                    if (movieExists(sanitizedMovie)) {
                        $('#movie-info').text(sanitizedMovie);
                        submitProfileData('favMovie', sanitizedMovie);
                    } else {
                        alert("Invalid movie input. Please enter a valid movie.");
                    }
                } else {
                    alert("Please enter a valid favorite movie.");
                }
            });

            $('#edit-director').click(function () {
                const newDirector = prompt("Enter your new favorite director:");
                if (newDirector && newDirector.trim() !== "") {
                    const sanitizedDirector = DOMPurify.sanitize(newDirector);
                    if (personExists(sanitizedDirector)) {
                        $('#director-info').text(sanitizedDirector);
                        submitProfileData('favDirector', sanitizedDirector);
                    } else {
                        alert("Invalid director input. Please enter a valid director.");
                    }
                } else {
                    alert("Please enter a valid favorite director.");
                }
            });

            // Similar logic for other edit buttons...

            // ...

            function submitProfileData(field, value) {
                $.ajax({
                    url: 'RabbitMQ/updateProfileData.php',
                    method: 'POST',
                    data: {
                        username: "<?php echo $_SESSION['username']; ?>",
                        field: field,
                        value: value
                    },
                    dataType: 'json',
                    success: function (result) {
                        // Handle success response if needed
                    },
                    error: function () {
                        console.log("Error updating profile data");
                    }
                });
            }
        }

        // Rest of your functions...
    </script>
    
</body>
</html>

