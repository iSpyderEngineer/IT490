<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.4/purify.min.js"></script>
    <link rel="stylesheet" href="styles.css"> 
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        #navbar-container {
            position: relative;
            z-index: 1;
        }

        h1 {
            text-align: center;
            margin-top: 20px;
        }

        #username {
            background-color: #1a5276; /* Dark blue */
            color: #fff;
            padding: 10px;
            padding-bottom: 20px; /* Add padding at the bottom to create space */
        }
   

        #username-info {
            margin: 0;
        }

        .profile-section {
            background-color: #3498db; /* Lighter blue */
            padding: 15px;
            margin-bottom: 15px;
        }

        .profile-section h2 {
            margin-bottom: 10px;
            color: #fff;
        }

        #rate {
            margin-top: 20px;
            background-color: #3498db;
            padding: 10px;
        }

        #rate-info {
            margin: 0;
            transform: rotate(-45deg); /* Reverse the rotation */
            display: inline-block; /* Display as inline block to prevent overflow issues */
            position: relative; /* Position relative for z-index to work */
            z-index: 1;
        }

        #edit-profile-button {
            display: block;
            margin: 20px auto;
            padding: 10px;
            font-size: 16px;
        }

        #edit-profile-form {
            display: none;
            background-color: #3498db; /* Lighter blue */
            padding: 15px;
            margin-top: 20px;
        }

        #profile-form label,
        #profile-form textarea,
        #profile-form input {
            display: block;
            margin-bottom: 10px;
        }

        #profile-form textarea {
            resize: vertical;
        }

        #submit-edit {
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="navbar-container"></div>
    

    <div id="username">
        <h2>Username</h2>
        <p id="username-info"></p>
    </div>

    <div id="actor">
        <h2>Favorite Actor</h2>
        <p id="actor-info"></p>
    </div>

    <div id="movie">
        <h2>Favorite Movie</h2>
        <p id="movie-info"></p>
    </div>

    <div id="director">
        <h2>Favorite Director</h2>
        <p id="director-info"></p>
    </div>

    <div id="genre">
        <h2>Favorite Genre</h2>
        <p id="genre-info"></p>
    </div>

    <div id="rate">
        <h2>Rate Score</h2>
        <p id="rate-info"></p>
    </div>

    <div id="bio">
        <h2>Bio</h2>
        <p id="bio-info"></p>
    </div>

    <!-- the form that gets populated and revealed so that users can edit their own profile -->
    <div id="edit-profile-form" style="display: none;">
        <h2>Edit Profile</h2>
        <form id="profile-form">
            <label for="edit-actor-input">Favorite Actor:</label>
            <input type="text" id="edit-actor-input" name="edit-actor-input" required>
            <br>

            <label for="edit-movie-input">Favorite Movie:</label>
            <input type="text" id="edit-movie-input" name="edit-movie-input" required>
            <br>

            <label for="edit-director-input">Favorite Director:</label>
            <input type="text" id="edit-director-input" name="edit-director-input" required>
            <br>

            <label for="edit-genre-input">Favorite Genre:</label>
            <input type="text" id="edit-genre-input" name="edit-genre-input" required>
            <br>

            <label for="edit-bio-input">Biography:</label>
            <textarea id="edit-bio-input" name="edit-bio-input" rows="4" cols="50" required></textarea>
            <br>

            <button type="button" id="submit-edit">Submit</button>
        </form>
    </div>

    <button id="edit-profile-button">Edit Profile</button>

    <script>
        $(document).ready(function () {
            // Loads the navbar component
            $('#navbar-container').load('components/navbar.html', function () {
                

                // Event listener for the "Profile" link in the navbar
                $('#profile-link').click(function (event) {
                    event.preventDefault(); // Prevent the default link behavior
                    loadProfileData();
                });

                // Check if it's the user's own profile page to enable edit functionality, set up for potential future proofing but doesn't really check as of writing
                const isOwnProfile = isCurrentUserProfile(); // Function to check if it's the user's own profile
                if (isOwnProfile) {
                    enableEditFunctionality();
                }

                // Explicitly call loadProfileData() after the document is ready (safety check)
                loadProfileData();
            });
        });

        function isCurrentUserProfile() {
            const currentSessionUsername = sessionStorage.getItem('username');
            const profileUsername = "";  // This exists for in the future if we let users see each other's profile pages's
            return true;
        }

        function loadProfileData() {
            const username = sessionStorage.getItem('username');
            $.ajax({
                url: 'RabbitMQ/dbConsumer.php',
                method: 'GET',
                data: { type: 'getUserProfile', username: username },
                dataType: 'json',
                success: function (result) {
                    if (result && result.length > 0) {
                        const userProfile = result[0];

                        if (userProfile.FavoriteActor) {
                            $('#actor-info').text(userProfile.FavoriteActor);
                            $('#edit-actor-input').val(userProfile.FavoriteActor);
                        }
                        if (userProfile.FavoriteMovie) {
                            $('#movie-info').text(userProfile.FavoriteMovie);
                            $('#edit-movie-input').val(userProfile.FavoriteMovie);
                        }
                        if (userProfile.FavoriteDirector) {
                            $('#director-info').text(userProfile.FavoriteDirector);
                            $('#edit-director-input').val(userProfile.FavoriteDirector);
                        }
                        if (userProfile.FavoriteGenres) {
                            $('#genre-info').text(userProfile.FavoriteGenres);
                            $('#edit-genre-input').val(userProfile.FavoriteGenres);
                        }
                        if (userProfile.RateScore) {
                            $('#rate-info').text(userProfile.RateScore);
                        }
                        if (userProfile.Biography) {
                            $('#bio-info').text(userProfile.Biography);
                            $('#edit-bio-input').val(userProfile.Biography);
                        }

                        // Displays the username
                        $('#username-info').text(username);
                    }
                },
                error: function () {
                    console.log("Error loading profile data");
                }
            });
        }

        function enableEditFunctionality() {
            // Edit Profile button event listener
            $(document).on('click', '#edit-profile-button', function () {
                // Show the edit profile form
                $('#edit-profile-form').show();
            });

            // Submit Edit button event listener
            $(document).on('click', '#submit-edit', function () {
                // Validate and submit the edited profile data
                const editedActor = $('#edit-actor-input').val();
                const editedMovie = $('#edit-movie-input').val();
                const editedDirector = $('#edit-director-input').val();
                const editedGenre = $('#edit-genre-input').val();
                const editedBio = $('#edit-bio-input').val();

                

                // Prepares the payload with all edited data
                const payload = {
                    type: 'updateProfile',
                    username: sessionStorage.getItem('username'),
                    favActor: editedActor,
                    favMovie: editedMovie,
                    favDirector: editedDirector,
                    favGenre: editedGenre,
                    biography: editedBio
                };

                // Submit the edited data in one payload
                submitEditedData(payload);

                // Hide the edit profile form after submission
                $('#edit-profile-form').hide();
            });
        }

        function submitEditedData(payload) {
            // Perform AJAX request to submit edited data
            $.ajax({
                url: 'RabbitMQ/dbConsumer.php',
                method: 'POST',
                data: payload,
                dataType: 'json',
                success: function (result) {
                    // Handle success response if needed
                    console.log('Profile data updated successfully:', result);
                },
                error: function () {
                    console.log("Error updating profile data");
                }
            });
        }
    </script>
    
</body>
</html>
