<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Watchedlist Management</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            padding: 20px;
        }

        h1 {
            text-align: center;
        }

        #watchedlist-container {
            max-width: 100%;
            overflow-x: auto;
        }

        .movie-container {
            display: flex;
            flex-wrap: nowrap;
            margin-bottom: 10px;
            justify-content: flex-start;
        }

        .movie-block {
            border: 1px solid #ccc;
            margin-right: 10px;
            padding: 10px;
            width: 250px; /* Adjusts the width as needed */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow: hidden;
        }

        .movie-block a {
            text-decoration: none;
            color: inherit;
            display: contents; /* Allows the link to wrap its children */
        }

        .movie-block img {
            width: 100%;
            height: 200px; /* Set a fixed height for all images */
            object-fit: cover; /* Maintain aspect ratio and cover the entire space */
        }

        .movie-details {
            text-align: center;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .movie-title {
            margin: 5px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .delete-button {
            margin-top: 10px;
            cursor: pointer;
            width: 100%;
            padding: 5px;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #ff0000;
            color: #ffffff;
            border: none;
        }

        .scroll-button {
            display: block;
            margin-top: 10px;
            padding: 5px;
            width: 100%;
            text-align: center;
            background-color: #007bff;
            color: #ffffff;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>Watchedlist Management</h1>

    <div id="navbar-container"></div>

    <div id="watchedlist-container">
        <!-- Display watchedlist here -->
    </div>

    <script>

        function loadNavbar() {
            const navbarContainer = document.getElementById('navbar-container');
            const xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        navbarContainer.innerHTML = xhr.responseText;
                    } else {
                        console.error('Error loading navbar:', xhr.status);
                    }
                }
            };
            xhr.open('GET', 'components/navbar.html', true);
            xhr.send();
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Retrieves the username from sessionStorage
            const username = sessionStorage.getItem('username');
            console.log('Username in sessionStorage:', username);

            loadNavbar();

            // Check if the username is available
            if (username) {
                // Make AJAX request to get watchedlist
                getWatchedlist(username);
            } else {
                console.log("Username not found in sessionStorage");
            }
        });

        function getWatchedlist(username) {
            $.ajax({
                url: 'RabbitMQ/dbConsumer.php',
                method: 'GET',
                data: {
                    type: 'getWatchedList',
                    username: username
                },
                dataType: 'json',
                success: function (response) {
                    displayWatchedlist(response);
                },
                error: function (error) {
                    console.error('Error fetching watchedlist:', error);
                }
            });
        }

        function addToWatchedlist() {
            const movieTitle = $('#movie-title').val();

            if (movieTitle) {
                $.ajax({
                    url: 'RabbitMQ/dbConsumer.php',
                    method: 'POST',
                    data: {
                        type: 'addToWatchedList',
                        username: sessionStorage.getItem('username'), // Retrieve username from sessionStorage
                        movieTitle: movieTitle
                    },
                    dataType: 'json',
                    success: function (response) {
                        console.log('Movie added to watchedlist:', response);
                        // Refresh watchedlist after adding a movie
                        getWatchedlist(sessionStorage.getItem('username'));
                    },
                    error: function (error) {
                        console.error('Error adding movie to watchedlist:', error);
                    }
                });
            } else {
                console.error('Movie title cannot be empty.');
            }
        }

        function deleteFromWatchedlist(listID) {
            console.log("requesting delete from watchedlist");
            const ListID = listID;

            if (ListID) {
                $.ajax({
                    url: 'RabbitMQ/dbConsumer.php',
                    method: 'POST',
                    data: {
                        type: 'deleteFromWatchedList',
                        watchedListID: ListID
                    },
                    dataType: 'json',
                    success: function (response) {
                        console.log('Movie deleted from watchedlist:', response);
                        // Refresh watchedlist after deleting a movie
                        getWatchedlist(sessionStorage.getItem('username'));
                    },
                    error: function (error) {
                        console.error('Error deleting movie from watchedlist:', error);
                    }
                });
            } else {
                console.error('Movie ID cannot be empty.');
            }
        }

        
        function displayWatchedlist(response) {
        const watchedlistContainer = document.getElementById('watchedlist-container');
        watchedlistContainer.innerHTML = '';

        if (response && response.length > 0) {
            // Display watchedlist
            const sectionTitle = document.createElement('h2');
            sectionTitle.textContent = 'Watchedlist';
            watchedlistContainer.appendChild(sectionTitle);

            // Create a container for the movie blocks with scrolling
            const movieContainer = document.createElement('div');
            movieContainer.classList.add('movie-container');
            watchedlistContainer.appendChild(movieContainer);

            response.forEach(movie => {
                const movieBlock = document.createElement('div');
                movieBlock.classList.add('movie-block');
                
                // Create the link for the movie image and title
                const movieLink = document.createElement('a');
                movieLink.href = `movie.html?Type=${movie.MediaType}&movieID=${movie.MovieID}`;
                
                // Create the movie image
                const movieImage = document.createElement('img');
                movieImage.src = movie.PosterURL;
                movieImage.alt = `${movie.MovieTitle} Poster`;
                
                // Create the movie details container
                const movieDetails = document.createElement('div');
                movieDetails.classList.add('movie-details');
                
                // Create the movie title
                const movieTitle = document.createElement('h3');
                movieTitle.classList.add('movie-title');
                movieTitle.textContent = movie.MovieTitle;
                
                // Create other details (year, delete button)
                const movieYear = document.createElement('p');
                movieYear.textContent = `Year: ${movie.Year}`;
                
                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-button');
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', function (event) {
                    event.stopPropagation(); // Prevent the click from reaching the parent (movieLink)
                    deleteFromWatchedlist(movie.ListID);
                });

                // Append elements to their respective parents
                movieDetails.appendChild(movieTitle);
                movieDetails.appendChild(movieYear);
                movieDetails.appendChild(deleteButton);
                
                movieLink.appendChild(movieImage);
                movieLink.appendChild(movieDetails);
                
                movieBlock.appendChild(movieLink);
                
                movieContainer.appendChild(movieBlock);
            });

            // Add style for movie title to limit its width and add ellipsis for overflow
            const style = document.createElement('style');
            style.textContent = `
                .movie-title {
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    margin: 0;
                }
            `;
            document.head.appendChild(style);

            // Add a button for scrolling to see more recommendations
            const scrollButton = document.createElement('button');
            scrollButton.textContent = 'See More';
            scrollButton.addEventListener('click', function () {
                movieContainer.scrollLeft += 200; // Adjusts the scrolling distance as needed
            });
            watchedlistContainer.appendChild(scrollButton);
        } else {
            // Handles the case where watchedlist is empty
            console.log('Watchedlist is empty');
            const emptySetResponse = [{"returnCode":"2","message":"Empty Set"}];
            if (JSON.stringify(response) === JSON.stringify(emptySetResponse)) {
                const noWatchedlistMessage = document.createElement('p');
                noWatchedlistMessage.textContent = 'Watchedlist is empty.';
                watchedlistContainer.appendChild(noWatchedlistMessage);
            } else {
                // In case of unexpected empty response
                const errorMessage = document.createElement('p');
                errorMessage.textContent = 'An error occurred while fetching the watchedlist.';
                watchedlistContainer.appendChild(errorMessage);
            }
        }
    }
    </script>
</body>
</html>


