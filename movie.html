<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Media Information</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="navbar-container"></div>

    <h1 id="media-title"></h1>

    <div id="media-info">
        <p><strong>Genre:</strong> <span id="genre"></span></p>
        <p><strong>Director:</strong> <span id="director"></span></p>
        <p><strong>Year:</strong> <span id="year"></span></p>
        <p><strong>Bio:</strong> <span id="bio"></span></p>
        <img src="" id="poster-image" alt="Media Poster">
    </div>

    <div id="reviews-container">
        <h2>Reviews</h2>
        <ul id="reviews-list"></ul>

        <h3>Add Your Review</h3>
        <form id="review-form">
            <label for="review-title">Review Title:</label><br>
            <input type="text" id="review-title" name="review-title" readonly><br>
            <label for="review-content">Review Content:</label><br>
            <textarea id="review-content" name="review-content"></textarea><br>
            <label for="review-rating">Rating:</label><br>
            <input type="number" id="review-rating" name="review-rating" min="1" max="5"><br>
            <input type="submit" value="Submit Review">
        </form>
    </div>

    <button id="add-to-watchlist">Add to Watchlist</button>
    <button id="add-to-watched-list">Add to Watched List</button>

    <script>
        // Declare global variables
        let mediaID;
        let mediaType;
        let mediaRequest;

        $(document).ready(function () {
            // Load the navbar component
            const navbarContainer = document.getElementById('navbar-container');
            const username = sessionStorage.getItem('username'); // Retrieve username from sessionStorage

            const xhr = new XMLHttpRequest();
            xhr.open('GET', 'components/navbar.html', true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                    navbarContainer.innerHTML = xhr.responseText;
                    loadMediaInfo();
                    console.log("document ready has been loaded");
                }
            };
            xhr.send();

            function loadMediaInfo() {
                console.log("load media info is starting");
                const urlParams = new URLSearchParams(window.location.search);
                mediaID = urlParams.get('movieID');
                mediaType = urlParams.get('Type'); // Added Type variable

                if (mediaID && mediaType) {
                    console.log("Media ID and Type found:", mediaID, mediaType);

                    // Use the new API endpoint that takes "Type" and "ID"
                    $.ajax({
                        url: 'RabbitMQ/apiConsumer.php',
                        method: 'GET',
                        dataType: 'json',
                        data: {
                            "type": "getMediaDetails",
                            "movieID": Number(mediaID),
                            "mediaType": mediaType,
                        },
                        success: function (result) {
                            if (result) {
                                console.log("API Result:", result);
                                mediaRequest = result;
                                displayMediaDetails(result, mediaType);
                                fetchMediaReviews(mediaID);
                                // Set review form title to media title
                                $('#review-title').val(result[mediaType === 'movie' ? 'Title' : 'name']);
                            }
                        },
                        error: function () {
                            console.log("Error loading media info");
                        }
                    });
                } else {
                    console.log("Media ID or Type not found:", mediaID, mediaType);
                }
            }

            $('#add-to-watchlist').click(function () {
                // Now you can use the global variables in other parts of the code
                addToWatchlist();
            });

            $('#add-to-watched-list').click(function () {
                // Now you can use the global variables in other parts of the code
                addToWatchedList();
            });

            // Fetch media reviews when the page loads
            function fetchMediaReviews(mediaID) {
                $.ajax({
                    url: 'RabbitMQ/dbConsumer.php',
                    method: 'GET',
                    data: {
                        "type": "searchMovieReviews",
                        "movieTitle": mediaRequest[mediaType === 'movie' ? 'Title' : 'name'],
                    },
                    dataType: 'json',
                    success: function (reviews) {
                        $('#reviews-list').empty(); // Clear existing reviews
                        if (reviews && reviews.length > 0) {
                            reviews.forEach(review => {
                                $('#reviews-list').append(`<li>${review.rating}/5 - ${review.review}</li>`);
                            });
                        } else {
                            $('#reviews-list').append('<li>No reviews available</li>');
                        }
                    },
                    error: function () {
                        console.log('Error fetching reviews');
                    }
                });
            }

            // Submit review function
            $('#review-form').submit(function (event) {
                event.preventDefault(); // Prevent default form submission

                const mediaTitle = $('#media-title').text();
                const reviewContent = $('#review-content').val();
                const reviewRating = $('#review-rating').val();

                $.ajax({
                    url: 'RabbitMQ/dbConsumer.php',
                    method: 'POST',
                    data: {
                        "type": "insertReview",
                        "username": username,
                        "MovieID": mediaID,
                        "movieTitle": mediaRequest[mediaType === 'movie' ? 'Title' : 'name'],
                        "rating": reviewRating,
                        "review": reviewContent,
                        "mediaType": mediaType,
                    },
                    success: function () {
                        console.log('Review submitted successfully');
                        // Clear form fields after submission
                        $('#review-title').val('');
                        $('#review-content').val('');
                        $('#review-rating').val('');
                        // Refresh the reviews list after submission
                        fetchMediaReviews(mediaID);
                    },
                    error: function () {
                        console.log('Error submitting review');
                    }
                });
            });

            // Display media details function
            function displayMediaDetails(mediaDetails, type) {
                $('#media-title').text(mediaDetails[type === 'movie' ? 'Title' : 'name']);
                $('#genre').text(mediaDetails.Genre.join(', '));
                $('#director').text(mediaDetails.Director);
                $('#year').text(type === 'movie' ? mediaDetails.ReleaseDate.substring(0, 4) : mediaDetails.first_air_date.substring(0, 4));
                $('#bio').text(mediaDetails.Overview);
                $('#poster-image').attr('src', mediaDetails.PosterURL); // Update poster image src
                // Update other elements with additional details if needed
            }

            // Add to watchlist function
            function addToWatchlist() {
                // Send the media title to RabbitMQ for processing (similar to addToWatchedList function)
                // Include username if needed
                $.ajax({
                    url: 'RabbitMQ/dbConsumer.php', // Replace with actual URL
                    method: 'POST',
                    data: {
                        "type": "addToWatchList",
                        "username": username,
                        "MovieID": mediaID,
                        "movieTitle": mediaRequest[mediaType === 'movie' ? 'Title' : 'name'],
                        "posterURL": mediaRequest.PosterURL,
                        "year": mediaType === 'movie' ? mediaRequest.ReleaseDate.substring(0, 4) : mediaRequest.first_air_date.substring(0, 4),
                        "mediaType": mediaType,
                    },
                    success: function () {
                        console.log(`Media added to watch list: ${mediaRequest[mediaType === 'movie' ? 'Title' : 'name']}`);
                    },
                    error: function () {
                        console.log("Error adding media to watch list");
                    }
                });
            }

            // Add to watched list function
            function addToWatchedList() {
                // Send the media title to RabbitMQ for processing (similar to addToWatchlist function)
                // Include username if needed
                $.ajax({
                    url: 'RabbitMQ/dbConsumer.php', // Replace with actual URL
                    method: 'POST',
                    data: {
                        "type": "addToWatchedList",
                        "username": username,
                        "MovieID": Number(mediaID),
                        "movieTitle": mediaRequest[mediaType === 'movie' ? 'Title' : 'name'],
                        "posterURL": mediaRequest.PosterURL,
                        "year": mediaType === 'movie' ? mediaRequest.ReleaseDate.substring(0, 4) : mediaRequest.first_air_date.substring(0, 4),
                        "mediaType": mediaType,
                    },
                    success: function () {
                        console.log(`Media added to watched list: ${mediaRequest[mediaType === 'movie' ? 'Title' : 'name']}`);
                    },
                    error: function () {
                        console.log("Error adding media to watched list");
                    }
                });
            }
        });

        // Call loadMediaInfo directly when the document is ready
        loadMediaInfo();
    </script>
</body>
</html>