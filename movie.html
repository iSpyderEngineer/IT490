<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Media Information</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="navbar-container"></div>

    <h1 id="media-title"></h1>

    <div id="media-info">
        <p><strong>Genre:</strong> <span id="genre"></span></p>
        <p><strong>Director:</strong> <span id="director"></span></p>
        <p><strong>Year:</strong> <span id="year"></span></p>
        <p><strong>Bio:</strong> <span id="bio"></span></p>
        <img src="" id="poster-image" alt="Media Poster">
    </div>

    <div id="reviews-container">
        <h2>Reviews</h2>
        <ul id="reviews-list"></ul>

        <h3>Add Your Review</h3>
        <form id="review-form">
            <label for="review-title">Review Title:</label><br>
            <input type="text" id="review-title" name="review-title" readonly><br>
            <label for="review-content">Review Content:</label><br>
            <textarea id="review-content" name="review-content"></textarea><br>
            <label for="review-rating">Rating:</label><br>
            <input type="number" id="review-rating" name="review-rating" min="1" max="5"><br>

            <!-- Add the fields for preferences -->
            <label for="favActor">Favorite Actor:</label><br>
            <input type="text" id="favActor" name="favActor"><br>
            <label for="favGenre">Favorite Genre:</label><br>
            <input type="text" id="favGenre" name="favGenre"><br>
            <label for="favDirector">Favorite Director:</label><br>
            <input type="text" id="favDirector" name="favDirector"><br>
            <label for="favMovie">Favorite Movie:</label><br>
            <input type="text" id="favMovie" name="favMovie"><br>
            <label for="biography">Biography:</label><br>
            <textarea id="biography" name="biography"></textarea><br>

            <input type="submit" value="Submit Review">
        </form>
    </div>

    <button id="add-to-watchlist">Add to Watchlist</button>
    <button id="add-to-watched-list">Add to Watched List</button>

    <script>
        // Declare global variables
        let mediaID;
        let mediaType;
        let mediaRequest;
        let username = sessionStorage.getItem('username'); // Retrieve username from sessionStorage

        $(document).ready(function () {
            // Load the navbar component
            const navbarContainer = document.getElementById('navbar-container');
            const xhr = new XMLHttpRequest();
            xhr.open('GET', 'components/navbar.html', true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                    navbarContainer.innerHTML = xhr.responseText;
                    loadMediaInfo();
                }
            };
            xhr.send();

            function loadMediaInfo() {
                const urlParams = new URLSearchParams(window.location.search);
                mediaID = urlParams.get('movieID');
                mediaType = urlParams.get('Type');

                if (mediaID && mediaType) {
                    $.ajax({
                        url: 'RabbitMQ/apiConsumer.php',
                        method: 'GET',
                        dataType: 'json',
                        data: {
                            "type": "getMediaDetails",
                            "movieID": Number(mediaID),
                            "mediaType": mediaType,
                        },
                        success: function (result) {
                            if (result) {
                                mediaRequest = result;
                                displayMediaDetails(result, mediaType);
                                fetchMediaReviews(mediaID);
                                $('#review-title').val(result[mediaType === 'movie' ? 'Title' : 'name']);
                            }
                        },
                        error: function () {
                            console.log("Error loading media info");
                        }
                    });
                } else {
                    console.log("Media ID or Type not found:", mediaID, mediaType);
                }
            }

            $('#add-to-watchlist').click(function () {
                addToWatchlist();
            });

            $('#add-to-watched-list').click(function () {
                addToWatchedList();
            });

            function fetchMediaReviews(mediaID) {
                $.ajax({
                    url: 'RabbitMQ/dbConsumer.php',
                    method: 'GET',
                    data: {
                        "type": "searchMovieReviews",
                        "movieTitle": mediaRequest[mediaType === 'movie' ? 'Title' : 'name'],
                    },
                    dataType: 'json',
                    success: function (reviews) {
                        $('#reviews-list').empty();
                        if (reviews && reviews.length > 0) {
                            reviews.forEach(review => {
                                $('#reviews-list').append(`<li>${review.rating}/5 - ${review.review}</li>`);
                            });
                        } else {
                            $('#reviews-list').append('<li>No reviews available</li>');
                        }
                    },
                    error: function () {
                        console.log('Error fetching reviews');
                    }
                });
            }

            $('#review-form').submit(function (event) {
                event.preventDefault();

                const mediaTitle = $('#media-title').text();
                const reviewContent = $('#review-content').val();
                const reviewRating = $('#review-rating').val();

                const payload = {
                    "type": "insertReview",
                    "username": username,
                    "MovieID": mediaID,
                    "movieTitle": mediaRequest[mediaType === 'movie' ? 'Title' : 'name'],
                    "rating": reviewRating,
                    "review": reviewContent,
                    "mediaType": mediaType,
                    "favActor": $('#favActor').val(),
                    "favGenre": $('#favGenre').val(),
                    "favDirector": $('#favDirector').val(),
                    "favMovie": $('#favMovie').val(),
                    "biography": $('#biography').val(),
                };

                sendToDBConsumer(payload, "Review submitted successfully");
            });

            function displayMediaDetails(mediaDetails, type) {
                $('#media-title').text(mediaDetails[type === 'movie' ? 'Title' : 'name']);
                $('#genre').text(mediaDetails.Genre.join(', '));
                $('#director').text(mediaDetails.Director);
                $('#year').text(type === 'movie' ? mediaDetails.ReleaseDate.substring(0, 4) : mediaDetails.first_air_date.substring(0, 4));
                $('#bio').text(mediaDetails.Overview);
                $('#poster-image').attr('src', mediaDetails.PosterURL);
            }

            function addToWatchlist() {
                const payload = {
                    "type": "addToWatchList",
                    "username": username,
                    "MovieID": mediaID,
                    "movieTitle": mediaRequest[mediaType === 'movie' ? 'Title' : 'name'],
                    "posterURL": mediaRequest.PosterURL,
                    "year": mediaType === 'movie' ? mediaRequest.ReleaseDate.substring(0, 4) : mediaRequest.first_air_date.substring(0, 4),
                    "mediaType": mediaType,
                };
                sendToDBConsumer(payload, "Media added to watch list");
            }

            function addToWatchedList() {
                const payload = {
                    "type": "addToWatchedList",
                    "username": username,
                    "MovieID": Number(mediaID),
                    "movieTitle": mediaRequest[mediaType === 'movie' ? 'Title' : 'name'],
                    "posterURL": mediaRequest.PosterURL,
                    "year": mediaType === 'movie' ? mediaRequest.ReleaseDate.substring(0, 4) : mediaRequest.first_air_date.substring(0, 4),
                    "mediaType": mediaType,
                };
                sendToDBConsumer(payload, "Media added to watched list");
            }

            function sendToDBConsumer(payload, successMessage) {
                $.ajax({
                    url: 'RabbitMQ/dbConsumer.php',
                    method: 'POST',
                    data: payload,
                    success: function () {
                        console.log(successMessage);
                    },
                    error: function () {
                        console.log(`Error ${successMessage}`);
                    }
                });
            }
        });

        loadMediaInfo(); // Call loadMediaInfo directly when the document is ready
    </script>
</body>
</html>

