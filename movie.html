<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Movie Information</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="navbar-container"></div>

    <h1 id="movie-title"></h1>

    <div id="movie-info">
        <p><strong>Genre:</strong> <span id="genre"></span></p>
        <p><strong>Director:</strong> <span id="director"></span></p>
        <p><strong>Year:</strong> <span id="year"></span></p>
        <p><strong>Bio:</strong> <span id="bio"></span></p>
        <img src="" id="poster-image" alt="Movie Poster">
    </div>

    <div id="reviews-container">
        <h2>Reviews</h2>
        <ul id="reviews-list"></ul>

        <h3>Add Your Review</h3>
        <form id="review-form">
            <label for="review-title">Review Title:</label><br>
            <input type="text" id="review-title" name="review-title"><br>
            <label for="review-content">Review Content:</label><br>
            <textarea id="review-content" name="review-content"></textarea><br>
            <input type="submit" value="Submit Review">
        </form>
    </div>

    <button id="add-to-watchlist">Add to Watchlist</button>
    <button id="add-to-watched-list">Add to Watched List</button>

    <script>
        // Load the navbar component
        const navbarContainer = document.getElementById('navbar-container');
        let username; // Declare the global username variable

        const xhr = new XMLHttpRequest();
        let movieRequest;
        xhr.open('GET', 'components/navbar.html', true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                navbarContainer.innerHTML = xhr.responseText;
                loadMovieInfo();
                fetchUsername(); // Fetch username when the page loads
            }
        };
        xhr.send();
        const urlParams = new URLSearchParams(window.location.search);
        let movieID = urlParams.get('movieID');

        function loadMovieInfo() {
            if (movieID) {
                console.log(movieID);

                // Use the new API endpoint that takes "Type" and "ID"
                $.ajax({
                    url: 'RabbitMQ/apiConsumer.php',
                    method: 'GET',
                    dataType: 'json',
                    data: {
                        "type": "getMediaDetails",
                        "movieID": Number(movieID),
                        "mediaType": "movie" // Adjust the mediaType as needed (e.g., "movie" or "tvshow")
                    },
                    success: function (result) {
                        if (result) {
                            console.log(result);
                            movieRequest = result;
                            displayMovieDetails(result);
                        }
                    },
                    error: function () {
                        console.log("Error loading movie info");
                    }
                });
            }
        }

        function fetchUsername() {
            // Fetch the username using AJAX from getUserInfo.php
            $.ajax({
                url: 'getUserInfo.php',
                method: 'GET',
                dataType: 'json',
                success: function (response) {
                    if (response.username) {
                        username = response.username; // Assign the fetched username to the global variable
                        console.log('Logged-in username:', username);
                        // Here you can use the username for your functionality
                        // For example, if needed, you can send the username while adding movies to the watchlist
                    } else {
                        console.log('User not logged in');
                        // Handle case where the user is not logged in
                    }
                },
                error: function () {
                    console.log('Error fetching user info');
                }
            });
        }

        $('#add-to-watchlist').click(function () {
            // Now you can use the global variable 'username' in other parts of the code
            addToWatchlist(movieID);
        });

        $('#add-to-watched-list').click(function () {
            // Now you can use the global variable 'username' in other parts of the code
            addToWatchedList(movieID);
        });

        // Fetch movie reviews when the page loads
        function fetchMovieReviews(movieID) {
            $.ajax({
                url: 'your-backend-endpoint-for-reviews', // Replace with actual backend endpoint
                method: 'GET',
                data: { title: movieID },
                dataType: 'json',
                success: function (reviews) {
                    if (reviews && reviews.length > 0) {
                        reviews.forEach(review => {
                            $('#reviews-list').append(`<li>${review.title}: ${review.content}</li>`);
                        });
                    } else {
                        $('#reviews-list').append('<li>No reviews available</li>');
                    }
                },
                error: function () {
                    console.log('Error fetching reviews');
                }
            });
        }

        // Submit review function
        $('#review-form').submit(function (event) {
            event.preventDefault(); // Prevent default form submission

            const movieTitle = $('#movie-title').text();
            const reviewTitle = $('#review-title').val();
            const reviewContent = $('#review-content').val();

            $.ajax({
                url: 'your-backend-endpoint-for-review-submission', // Replace with actual backend endpoint
                method: 'POST',
                data: {
                    title: movieTitle,
                    reviewTitle: reviewTitle,
                    reviewContent: reviewContent,
                },
                success: function () {
                    console.log('Review submitted successfully');
                    // Clear form fields after submission
                    $('#review-title').val('');
                    $('#review-content').val('');
                    // Refresh the reviews list after submission
                    fetchMovieReviews(movieTitle);
                },
                error: function () {
                    console.log('Error submitting review');
                }
            });
        }

        , function displayMovieDetails(movieDetails) {
            $('#movie-title').text(movieDetails.Title);
            $('#genre').text(movieDetails.Genre.join(', '));
            $('#director').text(movieDetails.Director);
            $('#year').text(movieDetails.ReleaseDate.substring(0, 4));
            $('#bio').text(movieDetails.Overview);
            $('#poster-image').attr('src', movieDetails.PosterURL); // Update poster image src
            // Update other elements with additional details if needed
        }

        , function addToWatchlist(movieID) {
            // Send the movie title to RabbitMQ for processing (similar to addToWatchedList function)
            // Include username if needed
            $.ajax({
                url: 'RabbitMQ/dbConsumer.php', // Replace with actual URL
                method: 'POST',
                data: {
                    "type": "addToWatchList",
                    "username": username,
                    "MovieID": Number(movieID),
                    "movieTitle": movieRequest.Title,
                    "posterURL": movieRequest.PosterURL,
                    "year": movieRequest.ReleaseDate.substring(0, 4),
                },
                success: function () {
                    console.log(`Movie added to watch list: ${movieRequest.Title}`);
                },
                error: function () {
                    console.log("Error adding movie to watch list");
                }
            });
        }

        , function addToWatchedList(movieID) {
            // Send the movie title to RabbitMQ for processing (similar to addToWatchlist function)
            // Include username if needed
            $.ajax({
                url: 'RabbitMQ/dbConsumer.php', // Replace with actual URL
                method: 'POST',
                data: {
                    "type": "addToWatchedList",
                    "username": username,
                    "MovieID": Number(movieID),
                    "movieTitle": movieRequest.Title,
                    "posterURL": movieRequest.PosterURL,
                    "year": movieRequest.ReleaseDate.substring(0, 4),
                },
                success: function () {
                    console.log(`Movie added to watched list: ${movieRequest.Title}`);
                },
                error: function () {
                    console.log("Error adding movie to watched list");
                }
            });
        }
        )
    </script>
</body>
</html>
       