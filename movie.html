<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Media Information</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="navbar-container"></div>

    <h1 id="media-title"></h1>

    <div id="media-info">
        <p><strong>Genre:</strong> <span id="genre"></span></p>
        <p><strong>Director:</strong> <span id="director"></span></p>
        <p><strong>Year:</strong> <span id="year"></span></p>
        <p><strong>Bio:</strong> <span id="bio"></span></p>
        <img src="" id="poster-image" alt="Media Poster">
    </div>

    <div id="reviews-container">
        <h2>Reviews</h2>
        <ul id="reviews-list"></ul>

        <h3>Add Your Review</h3>
        <form id="review-form">
            <label for="review-title">Review Title:</label><br>
            <input type="text" id="review-title" name="review-title"><br>
            <label for="review-content">Review Content:</label><br>
            <textarea id="review-content" name="review-content"></textarea><br>
            <input type="submit" value="Submit Review">
        </form>
    </div>

    <button id="add-to-watchlist">Add to Watchlist</button>
    <button id="add-to-watched-list">Add to Watched List</button>

    <script>
        $(document).ready(function () {
            // Load the navbar component
            const navbarContainer = document.getElementById('navbar-container');
            let username; // Declare the global username variable

            const xhr = new XMLHttpRequest();
            let mediaRequest;
            xhr.open('GET', 'components/navbar.html', true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                    navbarContainer.innerHTML = xhr.responseText;
                    loadMediaInfo();
                    console.log("document ready has been loaded");
                }
            };
            xhr.send();

            function loadMediaInfo() {
                console.log("load media info is starting");
                const urlParams = new URLSearchParams(window.location.search);
                let mediaID = urlParams.get('movieID');
                let Type = urlParams.get('Type'); // Added Type variable

                if (mediaID && Type) {
                    console.log("Media ID and Type found:", mediaID, Type);

                    // Use the new API endpoint that takes "Type" and "ID"
                    $.ajax({
                        url: 'RabbitMQ/apiConsumer.php',
                        method: 'GET',
                        dataType: 'json',
                        data: {
                            "type": "getMediaDetails",
                            "movieID": Number(mediaID),
                            "mediaType": Type,
                        },
                        success: function (result) {
                            if (result) {
                                console.log("API Result:", result);
                                mediaRequest = result;
                                displayMediaDetails(result, Type);
                            }
                        },
                        error: function () {
                            console.log("Error loading media info");
                        }
                    });
                } else {
                    console.log("Media ID or Type not found:", mediaID, Type);
                }
            }

            function fetchUsername() {
                // Fetch the username using AJAX from getUserInfo.php
                $.ajax({
                    url: 'getUserInfo.php',
                    method: 'GET',
                    dataType: 'json',
                    success: function (response) {
                        if (response.username) {
                            username = response.username; // Assign the fetched username to the global variable
                            console.log('Logged-in username:', username);
                            // Here you can use the username for your functionality
                            // For example, if needed, you can send the username while adding media to the watchlist
                        } else {
                            console.log('User not logged in');
                            // Handle case where the user is not logged in
                        }
                    },
                    error: function () {
                        console.log('Error fetching user info');
                    }
                });
            }

            $('#add-to-watchlist').click(function () {
                // Now you can use the global variable 'username' in other parts of the code
                addToWatchlist(mediaID);
            });

            $('#add-to-watched-list').click(function () {
                // Now you can use the global variable 'username' in other parts of the code
                addToWatchedList(mediaID);
            });

            // Fetch media reviews when the page loads
            function fetchMediaReviews(mediaID) {
                $.ajax({
                    url: 'your-backend-endpoint-for-reviews', // Replace with actual backend endpoint
                    method: 'GET',
                    data: { title: mediaID },
                    dataType: 'json',
                    success: function (reviews) {
                        if (reviews && reviews.length > 0) {
                            reviews.forEach(review => {
                                $('#reviews-list').append(`<li>${review.title}: ${review.content}</li>`);
                            });
                        } else {
                            $('#reviews-list').append('<li>No reviews available</li>');
                        }
                    },
                    error: function () {
                        console.log('Error fetching reviews');
                    }
                });
            }

            // Submit review function
            $('#review-form').submit(function (event) {
                event.preventDefault(); // Prevent default form submission

                const mediaTitle = $('#media-title').text();
                const reviewTitle = $('#review-title').val();
                const reviewContent = $('#review-content').val();

                $.ajax({
                    url: 'your-backend-endpoint-for-review-submission', // Replace with actual backend endpoint
                    method: 'POST',
                    data: {
                        title: mediaTitle,
                        reviewTitle: reviewTitle,
                        reviewContent: reviewContent,
                    },
                    success: function () {
                        console.log('Review submitted successfully');
                        // Clear form fields after submission
                        $('#review-title').val('');
                        $('#review-content').val('');
                        // Refresh the reviews list after submission
                        fetchMediaReviews(mediaTitle);
                    },
                    error: function () {
                        console.log('Error submitting review');
                    }
                });
            });

            // Display media details function
            function displayMediaDetails(mediaDetails, type) {
                $('#media-title').text(mediaDetails[type === 'movie' ? 'Title' : 'name']);
                $('#genre').text(mediaDetails.Genre.join(', '));
                $('#director').text(mediaDetails.Director);
                $('#year').text(type === 'movie' ? mediaDetails.ReleaseDate.substring(0, 4) : mediaDetails.first_air_date.substring(0, 4));
                $('#bio').text(mediaDetails.Overview);
                $('#poster-image').attr('src', mediaDetails.PosterURL); // Update poster image src
                // Update other elements with additional details if needed
            }

            // Add to watchlist function
            function addToWatchlist(movieID) {
                // Send the media title to RabbitMQ for processing (similar to addToWatchedList function)
                // Include username if needed
                $.ajax({
                    url: 'RabbitMQ/dbConsumer.php', // Replace with actual URL
                    method: 'POST',
                    data: {
                        "type": "addToWatchList",
                        "username": username,
                        "MediaID": Number(mediaID),
                        "mediaTitle": mediaRequest[Type === 'movie' ? 'Title' : 'name'],
                        "posterURL": mediaRequest.PosterURL,
                        "year": type === 'movie' ? mediaRequest.ReleaseDate.substring(0, 4) : mediaRequest.first_air_date.substring(0, 4),
                    },
                    success: function () {
                        console.log(`Media added to watch list: ${mediaRequest[Type === 'movie' ? 'Title' : 'name']}`);
                    },
                    error: function () {
                        console.log("Error adding media to watch list");
                    }
                });
            }

            // Add to watched list function
            function addToWatchedList(mediaID) {
                // Send the media title to RabbitMQ for processing (similar to addToWatchlist function)
                // Include username if needed
                $.ajax({
                    url: 'RabbitMQ/dbConsumer.php', // Replace with actual URL
                    method: 'POST',
                    data: {
                        "type": "addToWatchedList",
                        "username": username,
                        "MediaID": Number(mediaID),
                        "mediaTitle": mediaRequest[Type === 'movie' ? 'Title' : 'name'],
                        "posterURL": mediaRequest.PosterURL,
                        "year": type === 'movie' ? mediaRequest.ReleaseDate.substring(0, 4) : mediaRequest.first_air_date.substring(0, 4),
                    },
                    success: function () {
                        console.log(`Media added to watched list: ${mediaRequest[Type === 'movie' ? 'Title' : 'name']}`);
                    },
                    error: function () {
                        console.log("Error adding media to watched list");
                    }
                });
            }
        });

        // Call loadMediaInfo directly when the document is ready
        loadMediaInfo();
    </script>
</body>
</html>

