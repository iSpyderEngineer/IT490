<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Recommendations</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div id="navbar-container"></div>

    <!-- Display the username in the header -->
    <h1 id="username-header">Loading...</h1>

    <div id="recommendations-container"></div>

    <script>
        $(document).ready(function() {
            // Load the navbar component
            const navbarContainer = document.getElementById('navbar-container');
            const usernameHeader = document.getElementById('username-header');

            const xhr = new XMLHttpRequest();
            xhr.open('GET', 'components/navbar.html', true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                    navbarContainer.innerHTML = xhr.responseText;
                    loadRecommendations();
                }
            };
            xhr.send();

            // Retrieve username from session storage
            const username = sessionStorage.getItem('username');

            if (!username) {
                // Redirect to login page if username is not found
                location.href = "index.html";
            }

            // Display the username in the header
            if (username) {
                usernameHeader.textContent = `${username}'s Recommendations`;
            }
        });

        function loadRecommendations() {
            // Fetch user's favorite movie from sessions
            $.ajax({
                url: 'RabbitMQ/apiConsumer.php',
                method: 'POST',
                data: {
                    type: 'getUserProfile',
                    username: '<?php echo $_SESSION["loggedInUser"]; ?>'
                },
                dataType: 'json',
                success: function(response) {
                    if (response && response.favoriteMovie) {
                        const favoriteMovie = response.favoriteMovie;
                        getRecommendationsByFavoriteMovie(favoriteMovie);
                        getRecommendationsByActorDirector(response.actorData);
                        getRecommendationsByGenre(response.genres);
                    } else {
                        // Handle case where user data is not found
                        console.log('User data not found');
                        displayNoRecommendationsMessage();
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error(errorThrown);
                    // Handle errors if any
                    displayNoRecommendationsMessage();
                }
            });
        }

        function getRecommendationsByFavoriteMovie(favoriteMovie) {
            // Fetch recommendations based on the user's favorite movie
            $.ajax({
                url: 'RabbitMQ/apiConsumer.php',
                method: 'POST',
                data: {
                    type: 'displayRecommendedMovies',
                    movieData: favoriteMovie,
                    source: 'favoriteMovie'
                },
                dataType: 'json',
                success: function(response) {
                    if (response && response.recommendations && response.recommendations.length > 0) {
                        // Display section title
                        displaySectionTitle('Recommendations Based on Favorite Movie');
                        displayRecommendations(response.recommendations);
                    } else {
                        // Handle case where no recommendations are found
                        console.log('No recommendations found based on favorite movie');
                        displayNoRecommendationsMessage();
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error(errorThrown);
                    // Handle errors if any
                    displayNoRecommendationsMessage();
                }
            });
        }

        function getRecommendationsByActorDirector(actorData) {
            // Fetch recommendations based on actor and director
            $.ajax({
                url: 'RabbitMQ/apiConsumer.php',
                method: 'POST',
                data: {
                    type: 'recommendationActorDirector',
                    username: '<?php echo $_SESSION["loggedInUser"]; ?>',
                    actorData: actorData
                },
                dataType: 'json',
                success: function(response) {
                    if (response && response.recommendations && response.recommendations.length > 0) {
                        // Display section title
                        displaySectionTitle('Recommendations Based on Actor/Director');
                        displayRecommendations(response.recommendations);
                    } else {
                        // Handle case where no recommendations are found
                        console.log('No recommendations found based on actor/director');
                        displayNoRecommendationsMessage();
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error(errorThrown);
                    // Handle errors if any
                    displayNoRecommendationsMessage();
                }
            });
        }


        function getRecommendationsByGenre(genres) {
            // Fetch recommendations based on favorite genre
            $.ajax({
                url: 'apiConsumer.php',
                method: 'POST',
                data: {
                    type: 'getMoviesByMovieAndGenre',
                    username: '<?php echo $_SESSION["loggedInUser"]; ?>',
                    genres: genres
                },
                dataType: 'json',
                success: function(response) {
                    if (response && response.recommendations && response.recommendations.length > 0) {
                        // Display section title
                        displaySectionTitle('Recommendations Based on Genre');
                        displayRecommendations(response.recommendations);
                    } else {
                        // Handle case where no recommendations are found
                        console.log('No recommendations found based on genre');
                        displayNoRecommendationsMessage();
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error(errorThrown);
                    // Handle errors if any
                    displayNoRecommendationsMessage();
                }
            });
        }

        function displaySectionTitle(title) {
            const recommendationsContainer = document.getElementById('recommendations-container');
            const sectionTitle = document.createElement('h2');
            sectionTitle.textContent = title;
            recommendationsContainer.appendChild(sectionTitle);
        }

        function displayRecommendations(recommendations) {
            const recommendationsContainer = document.getElementById('recommendations-container');

            // Loop through the recommendations and create movie blocks
            recommendations.forEach(movie => {
                const movieBlock = document.createElement('div');
                movieBlock.classList.add('movie-block');
                movieBlock.innerHTML = `
                    <h3>${movie.Title}</h3>
                    <p>Director: ${movie.Director}</p>
                    <p>Genre: ${movie.Genre}</p>
                    <p>Year: ${movie.Year}</p>
                    <img src="${movie.PosterURL}" alt="${movie.Title} Poster">
                    <!-- Add additional movie information here -->
                `;
                // Append each movie block to the recommendations container
                recommendationsContainer.appendChild(movieBlock);
            });
        }

        function displayNoRecommendationsMessage() {
            const recommendationsContainer = document.getElementById('recommendations-container');
            const noRecommendationsMessage = document.createElement('p');
            noRecommendationsMessage.textContent = 'No recommendations available.';
            recommendationsContainer.appendChild(noRecommendationsMessage);
        }
    </script>
</body>
</html>
